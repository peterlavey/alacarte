[build]
  publish = "client/dist"
  # Ensure root deps (e.g., mongodb for Functions) are installed, then build client
  command = "npm install --no-audit --no-fund && npm ci --prefix client && npm run build --prefix client"
  node_version = "20"

[functions]
  directory = "netlify/functions"
  # Ensure ESM support and proper bundling in Functions
  node_bundler = "esbuild"
  # Avoid bundling optional DB driver; it won't be required when USE_DB != "mongo"
  external_node_modules = ["mongodb"]

# Pretty API routes â†’ Netlify Function
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = true

# SPA fallback for client-side routing
[[redirects]]
  from = "/**"
  to = "/index.html"
  status = 200

# Local development with `netlify dev`
# - Runs Vite dev server from client in a special "netlify" mode so the
#   client uses Functions as its API base.
# - Proxies Functions and applies redirects in front of the Vite server.
[dev]
  framework = "#custom"
  command = "npm run dev --prefix client -- --mode netlify"
  targetPort = 5173
  port = 8888
  autoLaunch = true
