stages:
  - test
  - build
  - deploy
  - acceptance

default:
  image: node:20
  cache:
    key: ${CI_PROJECT_NAME}
    paths:
      - client/.npm/
      - server/.npm/
  before_script:
    - node --version
    - npm --version

# --- Server: Test ---
server:test:
  stage: test
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
  variables:
    npm_config_cache: .npm
  before_script:
    - cd server
    - npm ci --cache .npm --prefer-offline
  script:
    - npm test

# --- Client: Build (artifact for Pages) ---
client:build:
  stage: build
  variables:
    npm_config_cache: .npm
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
  before_script:
    - cd client
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run build
  artifacts:
    paths:
      - client/dist
    expire_in: 1 week

# --- Pages: Deploy Frontend ---
pages:
  stage: deploy
  needs:
    - job: client:build
      artifacts: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - rm -rf public
    - mv client/dist public
    - echo "" > public/.nojekyll
    - if [ -f public/index.html ]; then cp -f public/index.html public/404.html; fi
  artifacts:
    paths:
      - public
  tags: []

# --- Server: Build and push Docker image to GitLab Registry ---
server:image:build:
  image: docker:27
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  stage: deploy
  needs: [server:test]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Logging in to GitLab Container Registry $CI_REGISTRY"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/server:latest" server
    - docker push "$CI_REGISTRY_IMAGE/server:latest"

# --- Acceptance: Run Postman collection against server image ---
server:image:acceptance:
  image: postman/newman:6-alpine
  stage: acceptance
  needs:
    - job: server:image:build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  services:
    - name: $CI_REGISTRY_IMAGE/server:latest
      alias: server
  variables:
    NEWMAN_REPORTS_DIR: reports
  before_script:
    - mkdir -p "$NEWMAN_REPORTS_DIR"
    # wait for the server container to become healthy/responding
    - |
      echo "Waiting for server service to be ready at http://server:3001/api/health"
      for i in $(seq 1 60); do
        if wget -q -T 2 -O- http://server:3001/api/health > /dev/null 2>&1; then
          echo "Server is up"; break; fi; echo "...retry $i"; sleep 2;
      done
  script:
    - |
      newman run "docs/postman/Alacarte.postman_collection.json" \
        --env-var baseUrl=http://server:3001 \
        --reporters cli,junit \
        --reporter-junit-export "$NEWMAN_REPORTS_DIR/junit.xml"
  artifacts:
    when: always
    paths:
      - reports
    expire_in: 1 week
